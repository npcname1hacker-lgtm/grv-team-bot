# ɢʀᴠ戰隊管理系統

## 概述

這是一個完整的Discord機器人和網站控制面板整合系統，專為ɢʀᴠ戰隊打造。系統包含：
- Discord機器人（成員管理、申請系統、指令功能）
- Flask網站控制面板（用戶管理、機器人控制、申請審核）
- PostgreSQL資料庫（用戶數據、申請記錄）
- 多層級權限管理系統

## 用戶偏好

- 溝通語言：中文（繁體）
- 界面語言：全中文
- 風格：簡單直白、易於理解

## 系統架構

### 整合架構
系統採用雙服務架構，同時運行Discord機器人和網站：

- **整合啟動器**: `integrated_launcher.py` 統一啟動所有服務
- **Discord機器人**: 在後台異步運行，處理Discord事件
- **Flask網站**: 在獨立線程運行，提供網頁控制面板
- **資料庫**: PostgreSQL (Neon) 存儲所有數據

### 核心模組

#### Discord機器人模組
- `bot.py` - 機器人核心類，處理事件和指令
- `commands.py` - 指令註冊和處理
- `application_system.py` - 申請系統功能
- `config.py` - 配置管理

#### 網站模組
- `web_app.py` - Flask應用主程序
- `web_models.py` - 網站資料庫模型（用戶、權限等）
- `web/templates/` - HTML模板（登錄、儀表板、管理頁面）
- `web/static/` - 靜態資源（CSS、JavaScript）

#### 資料庫模組
- `models.py` - 機器人資料庫模型（申請記錄等）
- `web_models.py` - 網站資料庫模型（用戶賬號、權限）

### 權限系統

三層權限架構：
1. **HIGH (隊長)** - 完整權限：
   - 創建/刪除用戶賬號
   - 修改任何用戶的密碼和權限
   - 管理機器人指令
   - 所有審核和管理功能

2. **MEDIUM (副隊長/幹部)** - 基本功能：
   - 審核申請
   - 控制機器人發送訊息
   - 查看成員信息
   - 修改自己的資料

3. **LOW (受限用戶)** - 警告狀態：
   - 無法使用任何功能
   - 需要聯繫隊長申請權限提升

### 預設管理員賬號

系統自動創建三個管理員：
- **admin0803** (隊長) - 密碼: `admin0803+0815` - HIGH權限 ✅ Discord ID 已綁定
- **admin0815** (幹部) - 密碼: `admin-fan.wei.lun` - MEDIUM權限  
- **admin3** (幹部) - 密碼: `admin1331914` - MEDIUM權限

### 網站功能

#### 已實現功能
- ✅ **新用戶審核系統** ⭐ Discord DM申請
- ✅ 簡化用戶註冊（無需email/phone/Discord ID）
- ✅ 用戶登錄系統（檢查審核狀態）
- ✅ 儀表板（狀態概覽）
- ✅ 申請管理（查看、接受、拒絕）
- ✅ 機器人控制（讓機器人說話、查看頻道列表）
- ✅ 機器人狀態監控（即時狀態、延遲、伺服器數）
- ✅ 用戶管理（隊長專用）
- ✅ 個人設置（修改用戶名、密碼）
- ✅ 權限管理（隊長可調整用戶權限）
- ✅ **Discord 帳號綁定功能** ⭐ 隊長專用
- ✅ **忘記密碼功能** ⭐ 機器人 DM 驗證碼
- ✅ **語音/文字頻道管理** ⭐ 禁言/踢人/失聰/解禁言/解失聰
- ✅ **敏感詞過濾系統** ⭐ 自動刪除違規訊息
- ✅ **自動頻道掃描** ⭐ 文字/語音頻道自動列表
- ✅ **成員自動掃描** ⭐ 選擇頻道自動加載成員
- ✅ **加入/退出語音頻道** ⭐ 機器人可加入和退出
- ✅ **機器人文字轉語音** ⭐ 在語音頻道讀出文字

#### 計劃中功能
- ⏳ 自定義機器人指令（隊長專用）
- ⏳ 更多Discord伺服器管理功能

### 電子郵件功能

**已實現**：使用Resend郵件服務（每月免費3000封郵件）
- ✅ 註冊時電子郵件驗證碼
- ✅ 6位數驗證碼（10分鐘有效期）
- ✅ 倒數計時防止重複發送（60秒）
- ✅ 精美的HTML郵件模板
- ⏳ 密碼重置功能（已準備好，待實現）

用戶可以使用電子郵件註冊，無需電話號碼。

## 技術棧

### 後端
- **Flask** - 網站框架
- **Flask-Login** - 用戶認證
- **SQLAlchemy** - ORM資料庫
- **discord.py** - Discord API
- **bcrypt** - 密碼加密
- **PostgreSQL** - 資料庫

### 前端
- **Bootstrap 5** - UI框架
- **Font Awesome** - 圖標
- **原生JavaScript** - 互動功能

### 部署
- **Replit** - 雲端運行環境
- **Neon PostgreSQL** - 託管資料庫

## 啟動方式

系統通過 `integrated_launcher.py` 統一啟動：
- 先啟動Flask網站（端口5000）
- 然後啟動Discord機器人
- 如果機器人連接失敗，網站仍可正常使用

訪問: http://0.0.0.0:5000

## 環境變數

必需的環境變數：
- `DATABASE_URL` - PostgreSQL連接字串
- `DISCORD_TOKEN` - Discord機器人令牌
- `FLASK_SECRET_KEY` - Flask會話密鑰（可選）

可選的環境變數（用於擴展功能）：
- `SENDGRID_API_KEY` - 電子郵件服務
- `TWILIO_*` - SMS服務

## 最近變更

### 2025-12-01（第七階段 - 成員歡迎功能 + 自動改名）
- ✅ **歡迎功能完整實現**
  - 新成員加入時自動改名為 "ɢʀᴠ.{username}"
  - 支持參數化歡迎訊息模板（{username}、{servername}）
  - 自動發送歡迎訊息至指定頻道
- ✅ **數據庫模型** - WelcomeSettings 表存儲配置
- ✅ **網頁管理界面** - 隊長可自定義歡迎設置
- ✅ **預設歡迎頻道** - ID: 1411609976329338933
- ✅ **成員 Intent 已啟用** - 修復成員掃描問題
- ✅ **公告頻道預設** - ID: 1410846655980503040

### 2025-11-27（第六階段 - Lavalink 語音服務集成）
- ✅ **安裝 Lavalink 庫** - 支持外部音頻服務
- ✅ **Java 環境已配置** - OpenJDK 21 安裝完成
- ✅ **下載 Lavalink JAR** - 位置: `./lavalink/Lavalink.jar`
- ✅ **創建語音處理模組** - `voice_handler.py` 管理語音連接
- ✅ **Lavalink 配置文件** - `./lavalink/application.yml` 已配置
- ✅ **改進語音連接邏輯** - 更優雅的超時處理和降級方案
- ⚠️ **已知限制**: Replit UDP 限制導致直接 Discord 語音無法工作
- 📝 **用戶指南**: 
  1. 在本地或外部服務器運行: `java -jar lavalink/Lavalink.jar`
  2. 修改 `voice_handler.py` 中的 `lavalink_url` 指向您的 Lavalink 實例
  3. 或在支持 UDP 的服務器上部署此系統

### 2025-11-27（第五階段 - 完整語音控制 + 文字轉語音）
- ✅ **解禁言/解失聰按鈕** - 反向操作禁言和失聰
- ✅ **禁言/失聰持久化** - 數據庫記錄語音狀態
- ✅ **機器人退出按鈕** - 機器人可主動退出語音頻道
- ✅ **機器人保持連接** - 不自動退出，直到按退出按鈕
- ✅ **文字轉語音功能** - 機器人可在語音頻道讀出文字
- ✅ **新API端點**：
  - `/api/voice/leave` - 退出語音頻道
  - `/api/voice/unmute` - 解禁言
  - `/api/voice/undeafen` - 解失聰
  - `/api/voice/tts` - 文字轉語音
- ✅ **UI增強** - 添加解禁言、解失聰、退出、TTS輸入框

### 2025-11-27（第四階段 - UI改進 + DM按鈕 + 審核流程完善）
- ✅ **Discord DM審核按鈕** - 隊長收到DM時下面有✅批准和❌拒絕按鈕
- ✅ **按鈕點擊後禁用** - 防止重複審核，點擊後按鈕自動禁用
- ✅ **拒絕後允許重新註冊** - 拒絕帳號時直接刪除，用戶可用同名重新註冊
- ✅ **移除IP追蹤** - 刪除user_ip字段，DM申請只顯示名稱和時間
- ✅ **允許同一IP多人註冊** - 移除IP重複檢查限制
- ✅ **UI改進** - 三個橫選單移到下方不蓋住左上角名稱，頂部右角只顯示用戶名（移除重複菜單）
- ✅ **修復500錯誤** - 處理多線程預設用戶重複插入異常

### 2025-11-27（第三階段 - 審核系統完整重構）
- ✅ 簡化註冊表單（移除email、phone、Discord ID）
- ✅ 新註冊帳號自動設為待審核狀態（is_approved=False）
- ✅ 機器人自動發送Discord DM審核申請給隊長（名稱、時間）
- ✅ 隊長可通過Discord按鈕批准或拒絕帳號
- ✅ 帳號只有通過審核後才能登錄
- ✅ 用戶可自行修改用戶名（/api/change-username）
- ✅ 數據庫已遷移至新模型（is_approved、approval_status字段）

### 2025-11-27（第二階段 - 隊長專屬功能）
- ✅ 實現可縮小的左側導航菜單（三個橫線）
- ✅ 完整的語音頻道管理（踢人、禁言、失聰）
- ✅ 完整的文字頻道管理（踢人、禁言）
- ✅ 機器人重啟功能（隊長專用）
- ✅ 機器人活動狀態更新（隊長可自定義機器人狀態）
- ✅ 敏感詞過濾系統（自動刪除含敏感詞的訊息）

### 2025-11-27（第一階段 - 密碼重置系統）
- ✅ 添加完整忘記密碼功能（驗證碼系統 + Discord DM）
- ✅ 限制 Discord 帳號綁定只有隊長可用
- ✅ 創建密碼重置頁面和驗證頁面
- ✅ 添加 6 位數驗證碼系統（10分鐘有效期）

### 2025-10-18
- ✅ 創建完整的Flask網站控制面板
- ✅ 實現用戶認證和權限系統
- ✅ 整合Discord機器人和網站
- ✅ 添加機器人控制API（發送訊息、查看頻道、狀態監控）
- ✅ 實現申請管理界面
- ✅ 創建用戶管理功能（隊長專用）
- ✅ 添加用戶註冊功能（電子郵件驗證碼）
- ✅ 整合Resend郵件服務（3000封/月免費）
- ✅ 修復資料庫連接問題
- ✅ 改進啟動器，即使機器人離線網站也能運行
- ✅ 修復前端JavaScript錯誤

## 項目文件結構

```
.
├── integrated_launcher.py  # 整合啟動器
├── bot.py                  # Discord機器人核心
├── web_app.py             # Flask網站應用
├── web_models.py          # 網站資料庫模型
├── models.py              # 機器人資料庫模型
├── commands.py            # Discord指令
├── application_system.py  # 申請系統
├── config.py              # 配置管理
└── web/
    ├── templates/         # HTML模板
    │   ├── base.html
    │   ├── login.html
    │   ├── dashboard.html
    │   ├── applications.html
    │   ├── bot_control.html
    │   ├── users.html
    │   ├── settings.html
    │   └── restricted.html
    └── static/            # 靜態資源
        ├── css/
        │   └── style.css
        └── js/
            └── main.js
```

## 版本資訊

- **當前版本**: V1.02.0
- **創作者**: ɢʀᴠ戰隊隊長殤嵐
- **最後更新**: 2025-11-27
- **運行環境**: Replit (免費層) + SQLite 本地資料庫

## 新功能文檔

### 1. 完整審核系統
#### 新用戶註冊流程
```
用戶填表 → 只需 用戶名 + 密碼
↓
帳號創建為待審核狀態
↓
機器人發送Discord DM給隊長：
  機器人面板申請！！
  名稱：{username}
  IP：{user_ip}  
  時間：{current_time}
↓
隊長批准/拒絕（API調用）
↓
批准後用戶可正常登錄
```

#### 權限變更審核（待實現Discord按鈕）
- 類似流程用於成員權限變更
- 隊長審核通過後生效

#### 用戶名修改
- 用戶可在設置頁面自行修改用戶名
- 完整驗證和重複檢查

### 2. 隊長專屬功能
- **頻道管理**: 文字/語音頻道的禁言、踢人、失聰控制
- **機器人控制**: 重啟、狀態更新、敏感詞管理
- **敏感詞過濾**: 自動刪除違規訊息並通知用戶

### 3. UI/UX 改進
- ☰ 可縮小左側導航菜單
- 簡化註冊流程（無需email/phone）
- 用戶設置頁面支持用戶名修改

## 系統狀態

✅ **完全運行中** - 大多數功能已測試並可用：
- 🌐 網站控制面板：http://0.0.0.0:5000 ✓
- 👤 用戶登錄系統 ✓
- 📧 電子郵件驗證碼註冊 ✓
- 📋 應用管理、用戶管理、機器人控制 ✓
- 🔐 三層權限系統已實施 ✓
- 💾 PostgreSQL 資料庫 ✓
- 👋 歡迎功能 + 自動改名 ✓

## 部署選項

### 選項 1：Replit（目前環境）
- ✅ 快速部署、免費
- ❌ 會自動斷線（需要升級到付費方案才能 24/7 運行）
- 🌐 訪問：http://0.0.0.0:5000

### 選項 2：Wispbyte Free Tier（推薦永不斷線 ⭐）
- ✅ 24/7 永不斷線
- ✅ 完全免費（無需信用卡）
- ✅ 無需更新/續期
- ✅ 國小生也能用
- 📖 部署指南：見 `WISPBYTE_DEPLOYMENT.md`
- 🌐 自動獲得公開 URL

### 選項 3：Oracle Cloud Free Tier（進階用戶）
- ✅ 24/7 永久免費
- ✅ 高效能（4 核心、24GB 記憶體）
- ❌ 需要技術知識
- ❌ 台灣暫不支持
- 📖 部署指南：見 `ORACLE_CLOUD_DEPLOYMENT.md`

⚠️ **已知限制（Replit UDP）**：
- ❌ Discord 語音連接 - Replit 環境對 UDP 有限制，無法建立語音通道
  - 握手成功但音頻通道無法連接
  - 文字轉語音功能需要外部服務支持
  - **建議**: 使用 Wispbyte 或 Oracle Cloud 可解決此問題

💰 最推薦：**Wispbyte** = 最簡單 + 永遠免費！