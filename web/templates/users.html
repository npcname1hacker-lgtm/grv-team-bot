{% extends "base.html" %}

{% block title %}ç”¨æˆ¶ç®¡ç† - É¢Ê€á´ æˆ°éšŠç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-users-cog"></i> ç”¨æˆ¶ç®¡ç†</h2>
        <p class="text-muted">ç®¡ç†æ‰€æœ‰ç³»çµ±ç”¨æˆ¶è³¬è™Ÿ</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col">
        <button class="btn btn-success" onclick="showAddUserModal()">
            <i class="fas fa-user-plus"></i> æ–°å¢ç”¨æˆ¶
        </button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> ç”¨æˆ¶åˆ—è¡¨</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ç”¨æˆ¶å</th>
                        <th>æ¬Šé™ç­‰ç´š</th>
                        <th>é›»å­éƒµä»¶</th>
                        <th>é›»è©±</th>
                        <th>æœ€å¾Œç™»éŒ„</th>
                        <th>å‰µå»ºæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>
                            <strong>{{ user.username }}</strong>
                            {% if user.username == current_user.username %}
                            <span class="badge bg-primary">æ‚¨</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.role.name == 'HIGH' %}
                            <span class="badge bg-warning">{{ user.get_role_display() }}</span>
                            {% elif user.role.name == 'MEDIUM' %}
                            <span class="badge bg-success">{{ user.get_role_display() }}</span>
                            {% else %}
                            <span class="badge bg-danger">{{ user.get_role_display() }}</span>
                            {% endif %}
                        </td>
                        <td>{{ user.email or '-' }}</td>
                        <td>{{ user.phone or '-' }}</td>
                        <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'å¾æœª' }}</td>
                        <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser({{ user.id }})">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="changeUserPassword({{ user.id }})">
                                    <i class="fas fa-key"></i>
                                </button>
                                {% if user.username != current_user.username %}
                                <button class="btn btn-outline-danger" onclick="changeUserRole({{ user.id }})">
                                    <i class="fas fa-user-shield"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ç·¨è¼¯ç”¨æˆ¶æ¨¡æ…‹ -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç·¨è¼¯ç”¨æˆ¶</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">ç”¨æˆ¶å</label>
                        <input type="text" class="form-control" id="editUsername" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">é›»å­éƒµä»¶</label>
                        <input type="email" class="form-control" id="editEmail">
                    </div>
                    <div class="mb-3">
                        <label for="editPhone" class="form-label">é›»è©±è™Ÿç¢¼</label>
                        <input type="tel" class="form-control" id="editPhone">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="saveUserChanges()">ä¿å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>
</div>

<!-- æ›´æ”¹å¯†ç¢¼æ¨¡æ…‹ -->
<div class="modal fade" id="changePasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ›´æ”¹å¯†ç¢¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <input type="hidden" id="changePasswordUserId">
                    <div class="mb-3">
                        <label for="newUserPassword" class="form-label">æ–°å¯†ç¢¼</label>
                        <input type="password" class="form-control" id="newUserPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirmUserPassword" class="form-label">ç¢ºèªå¯†ç¢¼</label>
                        <input type="password" class="form-control" id="confirmUserPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-warning" onclick="savePasswordChange()">æ›´æ–°å¯†ç¢¼</button>
            </div>
        </div>
    </div>
</div>

<!-- æ›´æ”¹æ¬Šé™æ¨¡æ…‹ -->
<div class="modal fade" id="changeRoleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ›´æ”¹ç”¨æˆ¶æ¬Šé™</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="changeRoleForm">
                    <input type="hidden" id="changeRoleUserId">
                    <div class="mb-3">
                        <label for="newUserRole" class="form-label">æ¬Šé™ç­‰ç´š</label>
                        <select class="form-control" id="newUserRole" required>
                            <option value="high">é«˜ - éšŠé•·æ¬Šé™ï¼ˆæ‰€æœ‰åŠŸèƒ½ï¼‰</option>
                            <option value="medium">ä¸­ - åŸºæœ¬åŠŸèƒ½</option>
                            <option value="low">ä½ - å—é™ç”¨æˆ¶ï¼ˆè­¦å‘Šç‹€æ…‹ï¼‰</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        æ³¨æ„ï¼šä½æ¬Šé™ç”¨æˆ¶å°‡ç„¡æ³•ä½¿ç”¨ä»»ä½•åŠŸèƒ½ï¼Œä¸”æœƒçœ‹åˆ°è­¦å‘Šè¨Šæ¯
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-danger" onclick="saveRoleChange()">æ›´æ–°æ¬Šé™</button>
            </div>
        </div>
    </div>
</div>

<script>
function editUser(userId) {
    // ç²å–ç”¨æˆ¶è³‡æ–™ä¸¦å¡«å…¥è¡¨å–®
    document.getElementById('editUserId').value = userId;
    new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

function changeUserPassword(userId) {
    document.getElementById('changePasswordUserId').value = userId;
    new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
}

function changeUserRole(userId) {
    document.getElementById('changeRoleUserId').value = userId;
    new bootstrap.Modal(document.getElementById('changeRoleModal')).show();
}

function savePasswordChange() {
    const userId = document.getElementById('changePasswordUserId').value;
    const newPassword = document.getElementById('newUserPassword').value;
    const confirmPassword = document.getElementById('confirmUserPassword').value;
    
    if (newPassword !== confirmPassword) {
        alert('å…©æ¬¡è¼¸å…¥çš„å¯†ç¢¼ä¸ä¸€è‡´');
        return;
    }
    
    fetch('/api/admin/change-user-password', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            new_password: newPassword
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('å¯†ç¢¼å·²æ›´æ–°ï¼');
            location.reload();
        } else {
            alert('æ›´æ–°å¤±æ•—ï¼š' + data.error);
        }
    });
}

function saveRoleChange() {
    const userId = document.getElementById('changeRoleUserId').value;
    const newRole = document.getElementById('newUserRole').value;
    
    fetch('/api/admin/update-user-role', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            user_id: userId,
            role: newRole
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('æ¬Šé™å·²æ›´æ–°ï¼');
            location.reload();
        } else {
            alert('æ›´æ–°å¤±æ•—ï¼š' + data.error);
        }
    });
}

function checkBotStatus() {
    // å¯¦ç¾ç‹€æ…‹æª¢æŸ¥
    document.getElementById('statusIndicator').innerHTML = 'ğŸŸ¢ åœ¨ç·š';
}
</script>
{% endblock %}