{% extends "base.html" %}

{% block title %}頻道管理 - ɢʀᴠ戰隊管理系統{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-comments"></i> 頻道管理</h2>
    </div>
</div>

<ul class="nav nav-tabs mb-4">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#textChannels" type="button">
            <i class="fas fa-comments"></i> 文字頻道
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#voiceChannels" type="button">
            <i class="fas fa-microphone-alt"></i> 語音頻道
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#announcements" type="button">
            <i class="fas fa-megaphone"></i> 公告設置
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- 文字頻道 -->
    <div class="tab-pane fade show active" id="textChannels">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5>文字頻道列表</h5>
            </div>
            <div class="card-body">
                <table class="table" id="textChannelsTable">
                    <thead>
                        <tr>
                            <th>頻道名稱</th>
                            <th>ID</th>
                            <th>主題</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 語音頻道 -->
    <div class="tab-pane fade" id="voiceChannels">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5>語音頻道列表</h5>
            </div>
            <div class="card-body">
                <table class="table" id="voiceChannelsTable">
                    <thead>
                        <tr>
                            <th>頻道名稱</th>
                            <th>ID</th>
                            <th>使用者上限</th>
                            <th>目前人數</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 公告設置 -->
    <div class="tab-pane fade" id="announcements">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5>設置公告頻道</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="announcementChannel" class="form-label">公告頻道</label>
                    <select class="form-control" id="announcementChannel">
                        <option value="">-- 選擇頻道 --</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="setAnnouncementChannel()">
                    <i class="fas fa-save"></i> 保存設置
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 載入文字頻道
fetch('/api/channels/text-channels')
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector('#textChannelsTable tbody');
        const select = document.getElementById('announcementChannel');
        if (data.channels) {
            data.channels.forEach(ch => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>#${ch.name}</td><td>${ch.id}</td><td>${ch.topic || '-'}</td><td><button class="btn btn-sm btn-info">查看</button></td>`;
                
                const option = document.createElement('option');
                option.value = ch.id;
                option.textContent = '#' + ch.name;
                select.appendChild(option);
            });
        }
    });

// 載入語音頻道
fetch('/api/channels/voice-channels')
    .then(res => res.json())
    .then(data => {
        const tbody = document.querySelector('#voiceChannelsTable tbody');
        if (data.channels) {
            data.channels.forEach(ch => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${ch.name}</td><td>${ch.id}</td><td>${ch.user_limit || '無限'}</td><td>${ch.members_count || 0}</td><td><button class="btn btn-sm btn-info">查看</button></td>`;
            });
        }
    });

function setAnnouncementChannel() {
    const channelId = document.getElementById('announcementChannel').value;
    if (!channelId) {
        alert('請選擇頻道');
        return;
    }
    
    fetch('/api/channels/set-announcement', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channelId})
    })
    .then(res => res.json())
    .then(data => {
        alert(data.success ? '設置已保存！' : '設置失敗：' + data.error);
    });
}
</script>
{% endblock %}
