{% extends "base.html" %}

{% block title %}цнбш┐Ошинч╜о{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h4>ЁЯСЛ цнбш┐Ошинч╜о</h4>
                    <small>чВ║цЦ░цИРхУбшинч╜ошЗкхЛХцФ╣хРНхТМцнбш┐ОшиКцБп</small>
                </div>
                <div class="card-body">
                    <form id="welcomeForm">
                        <div class="mb-3">
                            <label for="isEnabled" class="form-label">хХЯчФицнбш┐ОхКЯшГ╜</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isEnabled" name="isEnabled" checked>
                                <label class="form-check-label" for="isEnabled">
                                    хХЯчФицЦ░цИРхУбцнбш┐ОхКЯшГ╜
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="channelId" class="form-label">цнбш┐Оща╗щБУ</label>
                            <select class="form-control" id="channelId" required>
                                <option value="">-- щБ╕цУЗща╗щБУ --</option>
                            </select>
                            <small class="text-muted">щаРшин: 1411609976329338933</small>
                        </div>

                        <div class="mb-3">
                            <label for="messageTemplate" class="form-label">цнбш┐ОшиКцБпцибцЭ┐</label>
                            <textarea class="form-control" id="messageTemplate" rows="4" placeholder="цнбш┐О {username} хКахЕе {servername}я╝Б">цнбш┐О {username} хКахЕе {servername}я╝Б</textarea>
                            <small class="text-muted d-block mt-2">
                                <strong>хПпчФихПГцХ╕я╝Ъ</strong><br>
                                тАв {username} - цЦ░цИРхУбчЪДцЪ▒чи▒<br>
                                тАв {servername} - ф╝║цЬНхЩихРНчи▒
                            </small>
                        </div>

                        <hr>

                        <div class="mb-3">
                            <h5>шЗкхЛХцФ╣хРНшинч╜о</h5>
                        </div>

                        <div class="mb-3">
                            <label for="autoRenameEnabled" class="form-label">хХЯчФишЗкхЛХцФ╣хРН</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoRenameEnabled" name="autoRenameEnabled" checked>
                                <label class="form-check-label" for="autoRenameEnabled">
                                    цЦ░цИРхУбхКахЕецЩВшЗкхЛХцФ╣хРН
                                </label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="renamePrefix" class="form-label">цФ╣хРНхЙНч╢┤</label>
                            <input type="text" class="form-control" id="renamePrefix" value="╔в╩Ас┤а." placeholder="╔в╩Ас┤а.">
                            <small class="text-muted">ф╛Л: ╔в╩Ас┤а.username</small>
                        </div>

                        <div class="alert alert-info mt-3">
                            <strong>чд║ф╛Ля╝Ъ</strong><br>
                            хжВцЮЬцЦ░цИРхУбцЪ▒чи▒цШп "хВ│хеЗ"я╝Мх░ЗшвлцФ╣хРНчВ║ "╔в╩Ас┤а.хВ│хеЗ"<br>
                            цнбш┐ОшиКцБпх░Зщбпчд║: "цнбш┐О хВ│хеЗ хКахЕе ╔в╩Ас┤ацИ░щЪКч╛дя╝Б"
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="saveWelcomeSettings()">
                                <i class="fas fa-save"></i> ф┐ЭхнШшинч╜о
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ш╝ЙхЕеща╗щБУхИЧшби
fetch('/api/bot/channels')
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById('channelId');
        if (data.channels) {
            data.channels.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch.id;
                option.textContent = `ЁЯУЭ ${ch.name}`;
                // шинч╜ощаРшинща╗щБУ
                if (ch.id === '1411609976329338933') {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
    })
    .catch(err => console.error('ш╝ЙхЕеща╗щБУхд▒цХЧ', err));

// ш╝ЙхЕех╖▓ф┐ЭхнШчЪДшинч╜о
fetch('/api/bot/channels')
    .then(res => res.json())
    .then(data => {
        // ш╝ЙхЕечП╛цЬЙшинч╜о
        const settings = {{ settings|tojson if settings else 'null' }};
        if (settings) {
            document.getElementById('isEnabled').checked = settings.is_enabled;
            document.getElementById('channelId').value = settings.channel_id;
            document.getElementById('messageTemplate').value = settings.message_template;
            document.getElementById('autoRenameEnabled').checked = settings.auto_rename_enabled;
            document.getElementById('renamePrefix').value = settings.rename_prefix;
        } else {
            // ф╜┐чФищаРшинхА╝
            document.getElementById('channelId').value = '1411609976329338933';
        }
    });

function saveWelcomeSettings() {
    const guildId = '{{ guild_id }}';
    const channelId = document.getElementById('channelId').value;
    const messageTemplate = document.getElementById('messageTemplate').value;
    const autoRenameEnabled = document.getElementById('autoRenameEnabled').checked;
    const renamePrefix = document.getElementById('renamePrefix').value;
    const isEnabled = document.getElementById('isEnabled').checked;
    
    if (!channelId) {
        alert('шлЛщБ╕цУЗцнбш┐Оща╗щБУ');
        return;
    }
    
    if (!messageTemplate.trim()) {
        alert('шлЛш╝╕хЕецнбш┐ОшиКцБп');
        return;
    }
    
    fetch('/api/welcome/save', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            guild_id: guildId,
            channel_id: channelId,
            message_template: messageTemplate,
            auto_rename_enabled: autoRenameEnabled,
            rename_prefix: renamePrefix,
            is_enabled: isEnabled
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('тЬЕ цнбш┐Ошинч╜ох╖▓ф┐ЭхнШя╝Б');
        } else {
            alert('тЭМ ф┐ЭхнШхд▒цХЧ: ' + data.error);
        }
    })
    .catch(err => {
        console.error('ф┐ЭхнШхд▒цХЧ', err);
        alert('тЭМ ф┐ЭхнШхд▒цХЧ: ' + err.message);
    });
}
</script>
{% endblock %}
