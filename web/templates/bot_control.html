{% extends "base.html" %}

{% block title %}æ©Ÿå™¨äººæ§åˆ¶ - É¢Ê€á´ æˆ°éšŠç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-robot"></i> æ©Ÿå™¨äººæ§åˆ¶å°</h2>
        <p class="text-muted">ç®¡ç†Discordæ©Ÿå™¨äººåŠŸèƒ½</p>
    </div>
</div>

<div class="row">
    <!-- è®“æ©Ÿå™¨äººèªªè©± -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comment"></i> è®“æ©Ÿå™¨äººèªªè©±</h5>
            </div>
            <div class="card-body">
                <form id="botSayForm">
                    <div class="mb-3">
                        <label for="channelSelect" class="form-label">é¸æ“‡é »é“</label>
                        <select class="form-control" id="channelSelect">
                            <option value="">é¸æ“‡é »é“...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="botMessage" class="form-label">è¨Šæ¯å…§å®¹</label>
                        <textarea class="form-control" id="botMessage" rows="4" placeholder="è«‹è¼¸å…¥è¦è®“æ©Ÿå™¨äººèªªçš„è©±..."></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="sendBotMessage()">
                        <i class="fas fa-paper-plane"></i> ç™¼é€è¨Šæ¯
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- æ©Ÿå™¨äººç‹€æ…‹ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-heartbeat"></i> æ©Ÿå™¨äººç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <div id="botStatus">
                    <p><strong>ç‹€æ…‹:</strong> <span id="statusIndicator">æª¢æŸ¥ä¸­...</span></p>
                    <p><strong>å»¶é²:</strong> <span id="latency">-</span></p>
                    <p><strong>é€£æ¥çš„ä¼ºæœå™¨:</strong> <span id="guildCount">-</span></p>
                    <p><strong>ç¸½æˆå“¡æ•¸:</strong> <span id="memberCount">-</span></p>
                </div>
                <button class="btn btn-warning" onclick="restartBot()">
                    <i class="fas fa-redo"></i> é‡å•Ÿæ©Ÿå™¨äºº
                </button>
                <button class="btn btn-info" onclick="checkBotStatus()">
                    <i class="fas fa-sync"></i> åˆ·æ–°ç‹€æ…‹
                </button>
            </div>
        </div>
    </div>
</div>

{% if current_user.role.name == 'HIGH' %}
<!-- éšŠé•·å°ˆå±¬åŠŸèƒ½ -->
<div class="row">
    <!-- æ©Ÿå™¨äººé‡å•Ÿ -->
    <div class="col-md-6 mb-4">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-crown"></i> éšŠé•·å°ˆå±¬ - æ©Ÿå™¨äººé‡å•Ÿ</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">é‡å•Ÿæ©Ÿå™¨äººä»¥æ‡‰ç”¨æœ€æ–°é…ç½®</p>
                <button class="btn btn-danger" onclick="confirmRestartBot()">
                    <i class="fas fa-power-off"></i> é‡å•Ÿæ©Ÿå™¨äºº
                </button>
            </div>
        </div>
    </div>
    
    <!-- æ©Ÿå™¨äººæ´»å‹•ç‹€æ…‹ -->
    <div class="col-md-6 mb-4">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5><i class="fas fa-crown"></i> éšŠé•·å°ˆå±¬ - æ©Ÿå™¨äººæ´»å‹•ç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="botActivity" class="form-label">æ©Ÿå™¨äººç‹€æ…‹</label>
                    <input type="text" class="form-control" id="botActivity" placeholder="ä¾‹å¦‚: å®ˆè­·æˆ°éšŠ">
                </div>
                <button class="btn btn-info" onclick="updateBotActivity()">
                    <i class="fas fa-check"></i> æ›´æ–°ç‹€æ…‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ–‡å­—é »é“æ§åˆ¶ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-comments"></i> æ–‡å­—é »é“æ§åˆ¶</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="textChannelSelect" class="form-label">é¸æ“‡é »é“</label>
                        <select class="form-control" id="textChannelSelect" onchange="loadTextChannelMembers()">
                            <option value="">é¸æ“‡é »é“...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="userToModerate" class="form-label">é¸æ“‡æˆå“¡</label>
                        <select class="form-control" id="userToModerate">
                            <option value="">é¸æ“‡æˆå“¡...</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-warning" onclick="muteTextUser()">
                        <i class="fas fa-mute"></i> ç¦è¨€
                    </button>
                    <button type="button" class="btn btn-danger" onclick="kickTextUser()">
                        <i class="fas fa-sign-out-alt"></i> è¸¢å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- èªéŸ³é »é“æ§åˆ¶ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-success">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-microphone"></i> èªéŸ³é »é“æ§åˆ¶</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="voiceChannelSelect" class="form-label">é¸æ“‡èªéŸ³é »é“</label>
                        <select class="form-control" id="voiceChannelSelect" onchange="loadVoiceChannelMembers()">
                            <option value="">é¸æ“‡èªéŸ³é »é“...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="voiceUserToModerate" class="form-label">é¸æ“‡æˆå“¡</label>
                        <select class="form-control" id="voiceUserToModerate">
                            <option value="">é¸æ“‡æˆå“¡...</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success" onclick="joinVoiceChannel()">
                        <i class="fas fa-sign-in-alt"></i> åŠ å…¥
                    </button>
                    <button type="button" class="btn btn-warning" onclick="leaveVoiceChannel()">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡º
                    </button>
                    <button type="button" class="btn btn-info" onclick="muteVoiceUser()">
                        <i class="fas fa-volume-mute"></i> ç¦è¨€
                    </button>
                    <button type="button" class="btn btn-info" onclick="unmuteVoiceUser()">
                        <i class="fas fa-volume-up"></i> è§£ç¦è¨€
                    </button>
                    <button type="button" class="btn btn-warning" onclick="deafenVoiceUser()">
                        <i class="fas fa-deaf"></i> å¤±è°
                    </button>
                    <button type="button" class="btn btn-warning" onclick="undeafenVoiceUser()">
                        <i class="fas fa-ear"></i> è§£å¤±è°
                    </button>
                    <button type="button" class="btn btn-danger" onclick="kickVoiceUser()">
                        <i class="fas fa-sign-out-alt"></i> è¸¢å‡º
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ•æ„Ÿè©éæ¿¾ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-secondary">
            <div class="card-header bg-secondary text-white">
                <h5><i class="fas fa-filter"></i> æ•æ„Ÿè©éæ¿¾ç®¡ç†</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="sensitiveWord" class="form-label">æ–°å¢æ•æ„Ÿè©</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="sensitiveWord" placeholder="è¼¸å…¥è¦éæ¿¾çš„è©å½™">
                        <button class="btn btn-secondary" type="button" onclick="addSensitiveWord()">
                            <i class="fas fa-plus"></i> æ–°å¢
                        </button>
                    </div>
                </div>
                <div id="sensitiveWordsList" class="mt-3">
                    <p class="text-muted">æ•æ„Ÿè©åˆ—è¡¨è¼‰å…¥ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function sendBotMessage() {
    const channel = document.getElementById('channelSelect').value;
    const message = document.getElementById('botMessage').value;
    
    if (!channel || !message.trim()) {
        alert('è«‹é¸æ“‡é »é“ä¸¦è¼¸å…¥è¨Šæ¯');
        return;
    }
    
    fetch('/api/bot/say', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            channel_id: channel,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¨Šæ¯å·²ç™¼é€ï¼');
            document.getElementById('botMessage').value = '';
        } else {
            alert('ç™¼é€å¤±æ•—ï¼š' + data.error);
        }
    });
}

function checkBotStatus() {
    // å¯¦ç¾æ©Ÿå™¨äººç‹€æ…‹æª¢æŸ¥
    fetch('/api/bot/status')
    .then(response => response.json())
    .then(data => {
        document.getElementById('statusIndicator').innerHTML = data.online ? 'ğŸŸ¢ åœ¨ç·š' : 'ğŸ”´ é›¢ç·š';
        document.getElementById('latency').textContent = data.latency + 'ms';
        document.getElementById('guildCount').textContent = data.guild_count;
        document.getElementById('memberCount').textContent = data.member_count;
    });
}

function restartBot() {
    if (confirm('ç¢ºå®šè¦é‡å•Ÿæ©Ÿå™¨äººå—ï¼Ÿ')) {
        fetch('/api/bot/restart', {method: 'POST'})
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('æ©Ÿå™¨äººæ­£åœ¨é‡å•Ÿï¼Œè«‹ç¨å€™...');
            } else {
                alert('éŒ¯èª¤: ' + data.error);
            }
        });
    }
}

function confirmRestartBot() {
    if (confirm('ç¢ºå®šè¦é‡å•Ÿæ©Ÿå™¨äººï¼Ÿé€™å¯èƒ½éœ€è¦å¹¾ç§’é˜')) {
        restartBot();
    }
}

function updateBotActivity() {
    const activity = document.getElementById('botActivity').value;
    if (!activity.trim()) {
        alert('è«‹è¼¸å…¥æ©Ÿå™¨äººç‹€æ…‹');
        return;
    }
    
    fetch('/api/bot/activity', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({activity: activity})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('æ©Ÿå™¨äººç‹€æ…‹å·²æ›´æ–°ï¼');
        } else {
            alert('æ›´æ–°å¤±æ•—: ' + data.error);
        }
    });
}

function muteTextUser() {
    const channel = document.getElementById('textChannelSelect').value;
    const user = document.getElementById('userToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/channel/mute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²ç¦è¨€ï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function kickTextUser() {
    const channel = document.getElementById('textChannelSelect').value;
    const user = document.getElementById('userToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/channel/kick', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²è¸¢å‡ºï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function muteVoiceUser() {
    const channel = document.getElementById('voiceChannelSelect').value;
    const user = document.getElementById('voiceUserToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/voice/mute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²ç¦è¨€ï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function deafenVoiceUser() {
    const channel = document.getElementById('voiceChannelSelect').value;
    const user = document.getElementById('voiceUserToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/voice/deafen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²å¤±è°ï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function kickVoiceUser() {
    const channel = document.getElementById('voiceChannelSelect').value;
    const user = document.getElementById('voiceUserToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/voice/kick', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²è¸¢å‡ºï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function unmuteVoiceUser() {
    const channel = document.getElementById('voiceChannelSelect').value;
    const user = document.getElementById('voiceUserToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/voice/unmute', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²è§£é™¤ç¦è¨€ï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function undeafenVoiceUser() {
    const channel = document.getElementById('voiceChannelSelect').value;
    const user = document.getElementById('voiceUserToModerate').value;
    if (!channel || !user) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“å’Œæˆå“¡');
        return;
    }
    
    fetch('/api/voice/undeafen', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channel, user_id: user})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) alert('å·²è§£é™¤å¤±è°ï¼');
        else alert('éŒ¯èª¤: ' + data.error);
    });
}

function leaveVoiceChannel() {
    fetch('/api/voice/leave', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        alert(data.message || data.error);
        if (data.success) {
            document.getElementById('voiceUserToModerate').innerHTML = '<option value="">é¸æ“‡æˆå“¡...</option>';
        }
    });
}

function botSpeak() {
    const text = document.getElementById('ttsText').value;
    if (!text.trim()) {
        alert('è«‹è¼¸å…¥æ–‡å­—');
        return;
    }
    
    fetch('/api/voice/tts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: text})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('æ©Ÿå™¨äººæ­£åœ¨èªªè©±...');
            document.getElementById('ttsText').value = '';
        } else {
            alert('éŒ¯èª¤: ' + data.error);
        }
    });
}

function addSensitiveWord() {
    const word = document.getElementById('sensitiveWord').value;
    if (!word.trim()) {
        alert('è«‹è¼¸å…¥æ•æ„Ÿè©');
        return;
    }
    
    fetch('/api/filter/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({word: word})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('å·²æ–°å¢æ•æ„Ÿè©');
            document.getElementById('sensitiveWord').value = '';
            loadSensitiveWords();
        } else {
            alert('éŒ¯èª¤: ' + data.error);
        }
    });
}

function loadSensitiveWords() {
    fetch('/api/filter/list')
    .then(r => r.json())
    .then(data => {
        const list = document.getElementById('sensitiveWordsList');
        if (data.words && data.words.length > 0) {
            let html = '<ul class="list-group">';
            data.words.forEach(w => {
                html += `<li class="list-group-item d-flex justify-content-between align-items-center">
                    ${w}
                    <button class="btn btn-sm btn-danger" onclick="removeSensitiveWord('${w}')">åˆªé™¤</button>
                </li>`;
            });
            html += '</ul>';
            list.innerHTML = html;
        } else {
            list.innerHTML = '<p class="text-muted">æš«ç„¡æ•æ„Ÿè©</p>';
        }
    });
}

function removeSensitiveWord(word) {
    fetch('/api/filter/remove', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({word: word})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            loadSensitiveWords();
        }
    });
}

// è¼‰å…¥é »é“åˆ—è¡¨
async function loadChannels() {
    try {
        const response = await fetch('/api/bot/channels');
        const data = await response.json();
        
        const select = document.getElementById('channelSelect');
        select.innerHTML = '<option value="">é¸æ“‡é »é“...</option>';
        
        if (data.channels) {
            data.channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `${channel.guild_name} - ${channel.name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥é »é“åˆ—è¡¨å¤±æ•—:', error);
    }
}

// è¼‰å…¥æ–‡å­—é »é“
async function loadTextChannels() {
    try {
        const response = await fetch('/api/channels/text-channels');
        const data = await response.json();
        
        const select = document.getElementById('textChannelSelect');
        select.innerHTML = '<option value="">é¸æ“‡é »é“...</option>';
        
        if (data.channels) {
            data.channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `${channel.guild_name} - ${channel.name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥æ–‡å­—é »é“å¤±æ•—:', error);
    }
}

// è¼‰å…¥èªéŸ³é »é“
async function loadVoiceChannels() {
    try {
        const response = await fetch('/api/channels/voice-channels');
        const data = await response.json();
        
        const select = document.getElementById('voiceChannelSelect');
        select.innerHTML = '<option value="">é¸æ“‡èªéŸ³é »é“...</option>';
        
        if (data.channels) {
            data.channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `${channel.guild_name} - ${channel.name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥èªéŸ³é »é“å¤±æ•—:', error);
    }
}

// è¼‰å…¥æ–‡å­—é »é“æˆå“¡
async function loadTextChannelMembers() {
    const channelId = document.getElementById('textChannelSelect').value;
    if (!channelId) {
        document.getElementById('userToModerate').innerHTML = '<option value="">é¸æ“‡æˆå“¡...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/channels/${channelId}/members`);
        const data = await response.json();
        
        const select = document.getElementById('userToModerate');
        select.innerHTML = '<option value="">é¸æ“‡æˆå“¡...</option>';
        
        if (data.members) {
            data.members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.nick;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥æ–‡å­—é »é“æˆå“¡å¤±æ•—:', error);
    }
}

// è¼‰å…¥èªéŸ³é »é“æˆå“¡
async function loadVoiceChannelMembers() {
    const channelId = document.getElementById('voiceChannelSelect').value;
    if (!channelId) {
        document.getElementById('voiceUserToModerate').innerHTML = '<option value="">é¸æ“‡æˆå“¡...</option>';
        return;
    }
    
    try {
        const response = await fetch(`/api/channels/${channelId}/members`);
        const data = await response.json();
        
        const select = document.getElementById('voiceUserToModerate');
        select.innerHTML = '<option value="">é¸æ“‡æˆå“¡...</option>';
        
        if (data.members) {
            data.members.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.nick;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥èªéŸ³é »é“æˆå“¡å¤±æ•—:', error);
    }
}

// æ©Ÿå™¨äººåŠ å…¥èªéŸ³é »é“
function joinVoiceChannel() {
    const channelId = document.getElementById('voiceChannelSelect').value;
    if (!channelId) {
        alert('è«‹é¸æ“‡èªéŸ³é »é“');
        return;
    }
    
    fetch('/api/voice/join', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({channel_id: channelId})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('æ©Ÿå™¨äººå·²åŠ å…¥ï¼');
            setTimeout(loadVoiceChannelMembers, 1000);
        } else {
            alert('åŠ å…¥å¤±æ•—: ' + data.error);
        }
    });
}

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ©Ÿå™¨äººç‹€æ…‹å’Œè¼‰å…¥é »é“
window.onload = function() {
    checkBotStatus();
    loadChannels();
    loadTextChannels();
    loadVoiceChannels();
    {% if current_user.role.name == 'HIGH' %}
    loadSensitiveWords();
    {% endif %}
};
</script>
{% endblock %}