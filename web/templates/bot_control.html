{% extends "base.html" %}

{% block title %}æ©Ÿå™¨äººæ§åˆ¶ - É¢Ê€á´ æˆ°éšŠç®¡ç†ç³»çµ±{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-robot"></i> æ©Ÿå™¨äººæ§åˆ¶å°</h2>
        <p class="text-muted">ç®¡ç†Discordæ©Ÿå™¨äººåŠŸèƒ½</p>
    </div>
</div>

<div class="row">
    <!-- è®“æ©Ÿå™¨äººèªªè©± -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comment"></i> è®“æ©Ÿå™¨äººèªªè©±</h5>
            </div>
            <div class="card-body">
                <form id="botSayForm">
                    <div class="mb-3">
                        <label for="channelSelect" class="form-label">é¸æ“‡é »é“</label>
                        <select class="form-control" id="channelSelect">
                            <option value="">é¸æ“‡é »é“...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="botMessage" class="form-label">è¨Šæ¯å…§å®¹</label>
                        <textarea class="form-control" id="botMessage" rows="4" placeholder="è«‹è¼¸å…¥è¦è®“æ©Ÿå™¨äººèªªçš„è©±..."></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="sendBotMessage()">
                        <i class="fas fa-paper-plane"></i> ç™¼é€è¨Šæ¯
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- æ©Ÿå™¨äººç‹€æ…‹ -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-heartbeat"></i> æ©Ÿå™¨äººç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <div id="botStatus">
                    <p><strong>ç‹€æ…‹:</strong> <span id="statusIndicator">æª¢æŸ¥ä¸­...</span></p>
                    <p><strong>å»¶é²:</strong> <span id="latency">-</span></p>
                    <p><strong>é€£æ¥çš„ä¼ºæœå™¨:</strong> <span id="guildCount">-</span></p>
                    <p><strong>ç¸½æˆå“¡æ•¸:</strong> <span id="memberCount">-</span></p>
                </div>
                <button class="btn btn-warning" onclick="restartBot()">
                    <i class="fas fa-redo"></i> é‡å•Ÿæ©Ÿå™¨äºº
                </button>
                <button class="btn btn-info" onclick="checkBotStatus()">
                    <i class="fas fa-sync"></i> åˆ·æ–°ç‹€æ…‹
                </button>
            </div>
        </div>
    </div>
</div>

{% if current_user.role.name == 'HIGH' %}
<!-- éšŠé•·å°ˆå±¬åŠŸèƒ½ -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-crown"></i> éšŠé•·å°ˆå±¬ - æŒ‡ä»¤ç®¡ç†</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-success" onclick="showAddCommandModal()">
                        <i class="fas fa-plus"></i> æ–°å¢æŒ‡ä»¤
                    </button>
                    <button class="btn btn-info" onclick="loadCustomCommands()">
                        <i class="fas fa-list"></i> ç®¡ç†ç¾æœ‰æŒ‡ä»¤
                    </button>
                </div>
                
                <div id="commandsList">
                    <!-- æŒ‡ä»¤åˆ—è¡¨å°‡åœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ–°å¢æŒ‡ä»¤æ¨¡æ…‹ -->
<div class="modal fade" id="addCommandModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢è‡ªå®šç¾©æŒ‡ä»¤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCommandForm">
                    <div class="mb-3">
                        <label for="commandName" class="form-label">æŒ‡ä»¤åç¨±</label>
                        <input type="text" class="form-control" id="commandName" placeholder="ä¾‹å¦‚: æˆ°éšŠè¦å‰‡" required>
                    </div>
                    <div class="mb-3">
                        <label for="commandAliases" class="form-label">æŒ‡ä»¤åˆ¥åï¼ˆå¯é¸ï¼‰</label>
                        <input type="text" class="form-control" id="commandAliases" placeholder="ç”¨é€—è™Ÿåˆ†éš”ï¼Œä¾‹å¦‚: è¦å‰‡,rule">
                    </div>
                    <div class="mb-3">
                        <label for="commandDescription" class="form-label">æŒ‡ä»¤æè¿°</label>
                        <input type="text" class="form-control" id="commandDescription" placeholder="ç°¡çŸ­æè¿°é€™å€‹æŒ‡ä»¤çš„ç”¨é€”" required>
                    </div>
                    <div class="mb-3">
                        <label for="commandResponse" class="form-label">å›æ‡‰å…§å®¹</label>
                        <textarea class="form-control" id="commandResponse" rows="6" placeholder="æ©Ÿå™¨äººåŸ·è¡Œæ­¤æŒ‡ä»¤æ™‚è¦å›æ‡‰çš„å…§å®¹..." required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-success" onclick="createCommand()">å‰µå»ºæŒ‡ä»¤</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function sendBotMessage() {
    const channel = document.getElementById('channelSelect').value;
    const message = document.getElementById('botMessage').value;
    
    if (!channel || !message.trim()) {
        alert('è«‹é¸æ“‡é »é“ä¸¦è¼¸å…¥è¨Šæ¯');
        return;
    }
    
    fetch('/api/bot/say', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            channel_id: channel,
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('è¨Šæ¯å·²ç™¼é€ï¼');
            document.getElementById('botMessage').value = '';
        } else {
            alert('ç™¼é€å¤±æ•—ï¼š' + data.error);
        }
    });
}

function checkBotStatus() {
    // å¯¦ç¾æ©Ÿå™¨äººç‹€æ…‹æª¢æŸ¥
    fetch('/api/bot/status')
    .then(response => response.json())
    .then(data => {
        document.getElementById('statusIndicator').innerHTML = data.online ? 'ğŸŸ¢ åœ¨ç·š' : 'ğŸ”´ é›¢ç·š';
        document.getElementById('latency').textContent = data.latency + 'ms';
        document.getElementById('guildCount').textContent = data.guild_count;
        document.getElementById('memberCount').textContent = data.member_count;
    });
}

function restartBot() {
    if (confirm('ç¢ºå®šè¦é‡å•Ÿæ©Ÿå™¨äººå—ï¼Ÿ')) {
        alert('é‡å•ŸåŠŸèƒ½å°‡åœ¨å¾ŒçºŒå¯¦ç¾');
    }
}

{% if current_user.role.name == 'HIGH' %}
function showAddCommandModal() {
    new bootstrap.Modal(document.getElementById('addCommandModal')).show();
}

function createCommand() {
    const name = document.getElementById('commandName').value;
    const aliases = document.getElementById('commandAliases').value;
    const description = document.getElementById('commandDescription').value;
    const response = document.getElementById('commandResponse').value;
    
    alert('è‡ªå®šç¾©æŒ‡ä»¤åŠŸèƒ½å°‡åœ¨å¾ŒçºŒå¯¦ç¾');
}
{% endif %}

// è¼‰å…¥é »é“åˆ—è¡¨
async function loadChannels() {
    try {
        const response = await fetch('/api/bot/channels');
        const data = await response.json();
        
        const select = document.getElementById('channelSelect');
        select.innerHTML = '<option value="">é¸æ“‡é »é“...</option>';
        
        if (data.channels) {
            data.channels.forEach(channel => {
                const option = document.createElement('option');
                option.value = channel.id;
                option.textContent = `${channel.guild_name} - ${channel.name}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('è¼‰å…¥é »é“åˆ—è¡¨å¤±æ•—:', error);
    }
}

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ©Ÿå™¨äººç‹€æ…‹å’Œè¼‰å…¥é »é“
window.onload = function() {
    checkBotStatus();
    loadChannels();
};
</script>
{% endblock %}